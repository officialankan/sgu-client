name: Security Scanning

on:
    pull_request:
        branches: [main, dev]
    push:
        branches: [main, dev]
    schedule:
        - cron: "0 0 * * 0" # Weekly on Sundays at midnight UTC

jobs:
    dependency-scan:
        name: Dependency Vulnerability Scan
        permissions:
            contents: read
            security-events: write
            actions: read
        uses: google/osv-scanner-action/.github/workflows/osv-scanner-reusable.yml@v2.3.1
        with:
            scan-args: |-
                --lockfile=requirements.txt:./uv.lock
            fail-on-vuln: false # Don't fail the build, just report findings

    code-scan:
        name: Code Security Scan
        runs-on: ubuntu-latest

        permissions:
            contents: read
            security-events: write # For uploading SARIF results

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v3

            - name: Set up Python
              run: uv python install 3.11

            - name: Run Bandit security scan
              run: |
                  uv tool install bandit[sarif]
                  uv tool run bandit -r src/ -f sarif -o bandit.sarif
              continue-on-error: true # Don't fail the build, just report findings

            - name: Upload Bandit results to GitHub Security
              uses: github/codeql-action/upload-sarif@v3
              if: always() # Upload even if scan found issues
              with:
                  sarif_file: bandit.sarif
                  category: code-security
